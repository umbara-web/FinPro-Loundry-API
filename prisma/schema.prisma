
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  CUSTOMER
  SUPER_ADMIN
  OUTLET_ADMIN
  WORKER
  DRIVER
}

enum Staff_Type {
  OUTLET_ADMIN
  WORKER
  DRIVER
}

enum Attendance_Status {
  PRESENT
  LATE
  ABSENT
}

enum Pickup_Request_Status {
  WAITING_DRIVER
  DRIVER_ASSIGNED
  PICKED_UP
  ARRIVED_OUTLET
  CANCELLED
}

enum Order_Status {
  CREATED
  WAITING_PAYMENT
  PAID
  IN_WASHING
  IN_IRONING
  IN_PACKING
  READY_FOR_DELIVERY
  ON_DELIVERY
  DELIVERED
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum Station_Task_Type {
  WASHING
  IRONING
  PACKING
}

enum Station_Task_Status {
  PENDING
  IN_PROGRESS
  NEED_BYPASS
  COMPLETED
}

enum Bypass_Request_Status {
  PENDING
  APPROVED
  REJECTED
}

enum Payment_Status {
  PENDING
  PAID
  FAILED
  EXPIRED
  REFUNDED
}

enum Driver_Task_Type {
  PICKUP
  DELIVERY
}

enum Driver_Task_Status {
  AVAILABLE
  ACCEPTED
  IN_PROGRESS
  DONE
  CANCELLED
}

enum Notification_Type {
  PAYMENT_REMINDER
  PICKUP_REQUEST
  DELIVERY_REQUEST
  BYPASS_REQUEST
}

enum Complaint_Type {
  DAMAGE
  LOST
  NOT_MATCH
  REJECTED
}

enum Complaint_Status {
  OPEN
  IN_REVIEW
  RESOLVED
  REJECTED
}

model RegisterToken {
  id Int @id @default(autoincrement())
  token String @unique
}

model User {
  id String @id @default(uuid())

  name String
  email String @unique
  password String
  role Role @default(CUSTOMER)
  phone String?
  birthDate DateTime?
  profile_picture_url String?
  lat String
  long String

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  staff Staff[]
  attendance Attendance[]
  customer_address Customer_Address[]
  pickup_request_customer Pickup_Request[] @relation("customer")
  pickup_request_driver Pickup_Request[] @relation("driver")
  order Order[]
  station_task Station_Task[]
  bypass_request Bypass_Request[]
  driver_task Driver_Task[]
  complaint Complaint[]
  complaint_messages ComplaintMessage[]

  isVerified Boolean @default(false)
  is_email_verified Boolean @default(false)
}

model Outlet {
  id String @id @default(uuid())

  name String
  address String
  city String @default("")
  manager String @default("")
  phone String @default("") 
  lat String @default("0")
  long String @default("0")
  service_radius Int @default(0)
  openTime  String?       // e.g., "08:00 - 21:00"
  status    OutletStatus @default(ACTIVE)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  

  staff Staff[]
  shift Shift[]
  attendance Attendance[]
  pickup_request Pickup_Request[]
  order Order[]
}

model Staff {
  id String @id @default(uuid())

  outlet_id String
  staff_id String @unique
  staff_type Staff_Type @default(WORKER)
  shift_id String?

  created_at DateTime @default(now())

  outlet Outlet @relation(fields: [outlet_id], references: [id])
  staff User @relation(fields: [staff_id], references: [id])
  shift Shift? @relation(fields: [shift_id], references: [id])
}

model Shift {
  id String @id @default(uuid())

  outlet_id String

  outlet Outlet @relation(fields: [outlet_id], references: [id])
  name String
  start_time String
  end_time String?

  attendance Attendance[]
  staff Staff[]
}

model Attendance {
  id String @id @default(uuid())

  staff_id String
  outlet_id String
  shift_id String
  check_in_at DateTime @default(now())
  check_out_at DateTime?
  status Attendance_Status @default(PRESENT)
  notes String?

  staff User @relation(fields: [staff_id], references: [id])
  outlet Outlet @relation(fields: [outlet_id], references: [id])
  shift Shift @relation(fields: [shift_id], references: [id])
}

model Customer_Address {
  id String @id @default(uuid())

  customer_id String
  label String
  recipient_name String
  recipient_phone String
  address String
  city String
  postal_code String
  notes String?
  lat String
  long String
  is_primary Boolean @default(false)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  customer User @relation(fields: [customer_id], references: [id])

  pickup_request Pickup_Request[]
}

model Laundry_Item {
  id String @id @default(uuid())

  name String
  category  ItemCategory
  price     Int
  unit      ItemUnit
  status    ItemStatus   @default(ACTIVE)
  imageUrl  String?

  order_item Order_Item[]
  station_task_item Station_Task_Item[]
}

model Pickup_Request {
  id String @id @default(uuid())

  customer_id String
  address_id String
  schedulled_pickup_at DateTime
  notes String?
  assigned_outlet_id String
  assigned_driver_id String?
  status Pickup_Request_Status @default(WAITING_DRIVER)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  customer User @relation("customer", fields: [customer_id], references: [id])
  customer_address Customer_Address @relation(fields: [address_id], references: [id])
  outlet Outlet @relation(fields: [assigned_outlet_id], references: [id])
  driver User? @relation("driver", fields: [assigned_driver_id], references: [id])

  order Order[]
}

model Order {
  id String @id @default(uuid())

  pickup_request_id String
  outlet_id String
  outlet_admin_id String
  total_weight Float
  price_total Float
  status Order_Status @default(CREATED)
  paid_at DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  pickup_request Pickup_Request @relation(fields: [pickup_request_id], references: [id])
  outlet Outlet @relation(fields: [outlet_id], references: [id])
  outlet_admin User @relation(fields: [outlet_admin_id], references: [id])

  order_item Order_Item[]
  station_task Station_Task[]
  payment Payment[]
  driver_task Driver_Task[]
  notification Notification[]
  complaint Complaint[]
}

model Order_Item {
  id String @id @default(uuid())

  order_id String
  laundry_item_id String
  itemName  String
  price     Int
  unit      String

  order Order @relation(fields: [order_id], references: [id])
  laundry_item Laundry_Item @relation(fields: [laundry_item_id], references: [id])
  qty Int
}

model Station_Task {
  id String @id @default(uuid())

  order_id String
  task_type Station_Task_Type @default(WASHING)
  worker_id String?
  started_at DateTime @default(now())
  finished_at DateTime?
  status Station_Task_Status @default(PENDING)

  order Order @relation(fields: [order_id], references: [id])
  worker User? @relation(fields: [worker_id], references: [id])

  station_task_item Station_Task_Item[]
  bypass_request Bypass_Request[]
}

model Station_Task_Item {
  id String @id @default(uuid())

  station_task_id String
  laundry_item_id String
  qty Int

  station_task Station_Task @relation(fields: [station_task_id], references: [id])
  laundry_item Laundry_Item @relation(fields: [laundry_item_id], references: [id])
}

model Bypass_Request {
  id String @id @default(uuid())

  station_task_id String
  outlet_admin_id String
  reason String
  status Bypass_Request_Status @default(PENDING)
  approved_at DateTime?

  station_task Station_Task @relation(fields: [station_task_id], references: [id])
  outlet_admin User @relation(fields: [outlet_admin_id], references: [id])
}

model Payment {
  id String @id @default(uuid())

  order_id String
  method String?
  amount Float?
  status Payment_Status @default(PENDING)
  payment_ref String?
  paid_at DateTime?
  payment_img_url String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order Order @relation(fields: [order_id], references: [id])
}

model Driver_Task {
  id String @id @default(uuid())

  order_id String
  driver_id String?
  task_type Driver_Task_Type
  status Driver_Task_Status @default(AVAILABLE) // Changed default to AVAILABLE as per logic
  started_at DateTime @default(now())
  finished_at DateTime?

  created_at DateTime @default(now())

  order Order @relation(fields: [order_id], references: [id])
  driver User? @relation(fields: [driver_id], references: [id])
}

model Notification {
  id String @id @default(uuid())

  order_id String
  type Notification_Type
  title String
  body String
  is_read Boolean

  created_at DateTime @default(now())

  order Order @relation(fields: [order_id], references: [id])
}

model Complaint {
  id String @id @default(uuid())

  order_id String
  customer_id String
  type Complaint_Type
  description String
  images String[]
  status Complaint_Status @default(OPEN)

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order Order @relation(fields: [order_id], references: [id])
  customer User @relation(fields: [customer_id], references: [id])
  
  messages ComplaintMessage[]
}

model ComplaintMessage {
  id           String    @id @default(uuid())

  complaint_id String
  sender_id    String
  message      String    @db.Text
  is_read      Boolean   @default(false)
  
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  complaint    Complaint @relation(fields: [complaint_id], references: [id])
  sender       User      @relation(fields: [sender_id], references: [id])

  @@index([complaint_id])
  @@index([sender_id])
}

enum OutletStatus {
  ACTIVE
  CLOSED
  RENOVATION
}

enum ItemCategory {
  CUCI_SETRIKA
  SATUAN
  DRY_CLEAN
}

enum ItemUnit {
  KG
  PCS
  M2
}

enum ItemStatus {
  ACTIVE
  INACTIVE
}
